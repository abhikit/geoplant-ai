<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GeoPlant AI üå±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  margin: 0;
  font-family: Inter, system-ui, sans-serif;
  background: #f4f6f5;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
}

h1 {
  color: #2e7d32;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 20px;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.08);
}

input, textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  background: #2e7d32;
  color: white;
  padding: 12px;
  border-radius: 8px;
  border: none;
  width: 100%;
  font-size: 15px;
  cursor: pointer;
}

#map {
  height: 260px;
  border-radius: 10px;
  margin-bottom: 10px;
}

.chat {
  max-height: 520px;
  overflow-y: auto;
}

.msg {
  padding: 10px;
  margin-bottom: 8px;
  border-radius: 8px;
}

.user {
  background: #e3f2fd;
  text-align: right;
}

.bot {
  background: #e8f5e9;
}

.env {
  display: grid;
  grid-template-columns: repeat(2,1fr);
  gap: 8px;
  margin-top: 10px;
}

.env div {
  background: #f9faf9;
  padding: 8px;
  border-radius: 6px;
  font-size: 13px;
}
</style>
</head>

<body>
<div class="container">

<h1>üå± GeoPlant AI</h1>
<p>Location-aware, image-assisted plant care advisor</p>

<div class="grid">

<!-- LEFT -->
<div class="card">
  <h3>üìç Choose Location</h3>

  <input id="city" placeholder="Type city name (e.g. Jaipur)">
  <div id="map"></div>

  <input id="lat" placeholder="Latitude">
  <input id="lon" placeholder="Longitude">

  <textarea id="question" rows="3"
    placeholder="Ask about plant disease, yellow leaves, care..."></textarea>

  <input type="file" id="image">

  <button onclick="sendMessage()">Analyze Plant</button>
</div>

<!-- RIGHT -->
<div class="card">
  <h3>üß† Conversation</h3>
  <div class="chat" id="chat"></div>

  <h3>üå¶ Environmental Factors</h3>
  <div class="env" id="env"></div>
</div>

</div>
</div>

<script>
let map = L.map('map').setView([26.9124, 75.7873], 10);
let marker = L.marker([26.9124, 75.7873]).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap'
}).addTo(map);

async function reverseGeocode(lat, lon) {
  const res = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
  );
  const data = await res.json();
  document.getElementById("city").value = data.address.city || data.address.town || data.address.village || "";
}

async function geocodeCity(city) {
  const res = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${city}`
  );
  const data = await res.json();
  if (data.length > 0) {
    const lat = parseFloat(data[0].lat);
    const lon = parseFloat(data[0].lon);
    updateLocation(lat, lon);
  }
}

function updateLocation(lat, lon) {
  document.getElementById("lat").value = lat.toFixed(5);
  document.getElementById("lon").value = lon.toFixed(5);
  marker.setLatLng([lat, lon]);
  map.setView([lat, lon], 12);
  reverseGeocode(lat, lon);
}

map.on("click", e => {
  updateLocation(e.latlng.lat, e.latlng.lng);
});

document.getElementById("city").addEventListener("change", e => {
  geocodeCity(e.target.value);
});

function addMsg(text, cls) {
  const div = document.createElement("div");
  div.className = "msg " + cls;
  div.innerText = text;
  document.getElementById("chat").appendChild(div);
  div.scrollIntoView();
}

async function sendMessage() {
  const fd = new FormData();
  fd.append("lat", document.getElementById("lat").value);
  fd.append("lon", document.getElementById("lon").value);
  fd.append("question", document.getElementById("question").value);
  fd.append("session_id", crypto.randomUUID());

  const img = document.getElementById("image").files[0];
  if (img) fd.append("image", img);

  addMsg(document.getElementById("question").value, "user");
  addMsg("Analyzing plant considering local environment‚Ä¶ üå±", "bot");

  const res = await fetch("/chat", { method: "POST", body: fd });
  const data = await res.json();

  document.getElementById("chat").lastChild.remove();
  addMsg(data.answer, "bot");

  const env = document.getElementById("env");
  env.innerHTML = "";
  for (const k in data.environment) {
    env.innerHTML += `<div><b>${k}</b><br>${data.environment[k]}</div>`;
  }
}
</script>

</body>
</html>
